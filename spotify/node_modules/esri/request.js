// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.
//>>built
define("require dojo/_base/array dojo/_base/config dojo/Deferred dojo/_base/lang dojo/_base/url dojo/request dojo/io-query dojo/when ./kernel ./config ./core/sniff ./core/lang ./core/urlUtils ./core/deferredUtils ./core/promiseUtils dojo/io/script dojo/io/iframe dojo/dom-construct".split(" "),function(W,x,B,S,n,J,C,Q,X,p,Y,q,y,g,Z,r,$,aa,T){function ba(a,c,b){if(b)return r.reject(n.mixin(Error(),{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));if(b=Q.objectToQuery(a.content))a.url+=
(-1===a.url.indexOf("?")?"?":"\x26")+b;b=new Image;a.allowImageDataAccess&&(a.withCredentials?b.crossOrigin="use-credentials":c&&(b.crossOrigin="anonymous"));b.src=a.url;return r.resolve(b)}function K(a){a=new J(a);return(a.host+(a.port?":"+a.port:"")).toLowerCase()}function F(a,c,b){var f=!!a.useProxy,e=a.method||"auto",k;k=a.crossOrigin;a=n.mixin({},a);a._ssl&&(a.url=a.url.replace(/^http:/i,"https:"));var D=a.content,m=a.url,d=c&&a.form;k=y.isDefined(k)?k:h.useCors;a.load=function(a){var b;a&&(a.error?
(b=n.mixin(Error(),a.error),b.log=B.isDebug):"error"===a.status&&(b=n.mixin(Error(),a),b.log=B.isDebug),b&&!y.isDefined(b.httpCode)&&(b.httpCode=b.code));return b||a};a.error=function(a,b){b&&b.xhr&&b.xhr.abort();a instanceof Error||(a=n.mixin(Error(),a));a.log=B.isDebug;return a};a._token&&(a.content=a.content||{},a.content.token=a._token);var L=0,l;m&&(l=Q.objectToQuery(D),L=l.length+m.length+1,q("esri-url-encodes-apostrophe")&&(L=l.replace(/'/g,"%27").length+m.length+1));a.timeout=y.isDefined(a.timeout)?
a.timeout:h.timeout;a.handleAs=a.handleAs||"json";try{var s,t,u=k&&g.canUseXhr(a.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(a.url),w=g.hasSameOrigin(a.urlObj,g.appUrl)||u,z="post"===e||c||L>h.maxUrlLength?!0:!1,A=!w&&-1!==a.handleAs.indexOf("json")&&a.callbackParamName&&!c?!0:!1,E=g.getProxyRule(a.url)||h.forceProxy||f||("image"!==a.handleAs||a.allowImageDataAccess)&&(!A||z)&&!w?!0:!1;c&&(!q("esri-file-upload")&&!E&&u)&&(E=!0);if(E)if(s=g.getProxyUrl(m,k),t=s.path,s._xo&&(u=!0),
!z&&t.length+1+L>h.maxUrlLength&&(z=!0),a.url=t+"?"+m,z)a.content=n.mixin(s.query||{},D);else{var U=Q.objectToQuery(n.mixin(s.query||{},D));U&&(a.url+=(-1===m.indexOf("?")?"?":"\x26")+U);a.content=null}if(A&&!z)return!y.isDefined(a.isAsync)&&4>q("ff")&&(a.isAsync=!0),$.get(v?v(a):a);var G=a.headers;if(!G||!G.hasOwnProperty("X-Requested-With"))G=a.headers=G||{},G["X-Requested-With"]=null;if(c){var M=a.callbackParamName||"callback.html",r=a.callbackElementName||"textarea",H,N,I,O,J=d.elements?d.elements.length:
0,R;if(D=a.content)for(H in D)if(I=D[H],y.isDefined(I)){N=null;for(O=0;O<J;O++)if(R=d.elements[O],R.name===H){N=R;break}N?N.value=I:b?d.append(H,I):d.appendChild(T.create("input",{type:"hidden",name:H,value:I}))}if(q("esri-file-upload"))x.forEach(d.elements,function(a){a.name===M&&d.removeChild(a)}),a.contentType=!1,a.postData=b?d:new FormData(d),delete a.form;else{d.enctype="multipart/form-data";9>q("ie")&&(d.encoding="multipart/form-data");d.method="post";x.some(d.elements,function(a){return a.name===
M})||d.appendChild(T.create("input",{type:"hidden",name:M,value:r}));if(-1!==m.toLowerCase().indexOf("addattachment")||-1!==m.toLowerCase().indexOf("updateattachment"))a.url=m+(-1===m.indexOf("?")?"?":"\x26")+M+"\x3d"+r,E&&(a.url=t+"?"+a.url);delete a.content}}if(u&&!a.hasOwnProperty("withCredentials"))if(b=E?t:m,-1!==x.indexOf(h.webTierAuthServers,K(b)))a.withCredentials=!0;else if(p.id){var F=p.id.findServerInfo(b);F&&F.webTierAuth&&(a.withCredentials=!0)}a=v?v(a):a;if("image"===a.handleAs)return ba(a,
u,z);if(z){a.data=a.content;if(c&&!q("esri-file-upload"))return aa.send(a);!E&&q("safari")&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+"_ts\x3d"+(new Date).getTime()+ca++);return C.post(a.url,a)}a.query=a.content;return C.get(a.url,a)}catch(P){return c=new S,c.reject(a.error(P)),c}}function P(a){var c=h.corsStatus,b=g.canUseXhr(a,!0);-1<b&&h.corsEnabledServers.splice(b,1);c[K(a)]=1;return b}function V(a){var c=h.corsStatus;try{var b=K(a.url);if(h.corsDetection&&h.useCors&&q("esri-cors")&&a.url&&
-1!==a.url.toLowerCase().indexOf("/rest/services")&&!g.hasSameOrigin(a.urlObj,g.appUrl)&&!g.canUseXhr(a.urlObj)){if(c[b])return c[b];var f=new S;c[b]=f.promise;var e=a.url.substring(0,a.url.toLowerCase().indexOf("/rest/")+6)+"info";C.get(e,{query:{f:"json"},failOk:!0,handleAs:"json",headers:{"X-Requested-With":null},timeout:1E3*h.corsDetectionTimeout}).then(function(c){c?(g.canUseXhr(a.url)||h.corsEnabledServers.push(b),f.resolve()):f.reject()},function(a){f.reject()});return f.promise}}catch(k){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}}
function w(a,c,b,f){function e(a){a._pendingDfd=F(b,s,r);if(a._pendingDfd)a._pendingDfd.then(function(b){var c=null;a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;if(b&&(b.error?(c=n.mixin(Error(),b.error),c.log=B.isDebug):"error"===b.status&&(c=n.mixin(Error(),b),c.log=B.isDebug),c&&!y.isDefined(c.httpCode)&&(c.httpCode=c.code),c))throw c;a.resolve({data:b,url:f.url,requestOptions:f.requestOptions});a._pendingDfd=null}).then(null,function(c){var A,d,e;c&&(A=c.code,d=c.subcode,e=(e=c.messageCode)&&
e.toUpperCase());if(c&&403==A&&(4==d||c.message&&-1<c.message.toLowerCase().indexOf("ssl")&&-1===c.message.toLowerCase().indexOf("permission"))){if(!b._ssl){b._ssl=b._sslFromServer=!0;w(a,!0,b,f);return}}else if(c&&415==c.status){if(P(b.url),!b._err415){b._err415=1;w(a,!0,b,f);return}}else if(p.id&&-1!==x.indexOf(p.id._errorCodes,A)&&!p.id._isPublic(b.url)&&!g&&(403!=A||-1===x.indexOf(da,e)&&(!y.isDefined(d)||2==d&&b._token))){ea(a,b,f,c);return}a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;a.reject(c);
a._pendingDfd=null});else{a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;var c=Error("Deferred object is missing");c.log=B.isDebug;a.reject(c);a._pendingDfd=null}}var k=b.form,g=b.disableIdentityLookup,m=b._preLookup,d=!1;if(q("esri-workers")&&!1!==h.useWorkers)if(!0===b.useWorkers||!0===h.useWorkers)d=!0;else if(b.workerOptions){var l=b.workerOptions;if(l.callback||l.worker&&l.worker.worker instanceof Worker)d=!0}var r=k&&q("esri-file-upload")&&k instanceof FormData,s=k&&(k.elements?x.some(k.elements,
function(a){return"file"===a.type}):r),t=-1!==b.url.toLowerCase().indexOf("token\x3d")||b.content&&b.content.token||s&&x.some(k.elements,function(a){return"token"===a.name})?1:0;if(!c){a.then(function(a){/\/sharing\/rest\/accounts\/self/i.test(b.url)&&(!t&&!b._token&&a.user&&a.user.username)&&h.webTierAuthServers.push(K(b.url));var c=b._credential;if(c){var d=p.id.findServerInfo(c.server);if(d=d&&d.owningSystemUrl)d=d.replace(/\/?$/,"/sharing"),(c=p.id.findCredential(d,c.userId))&&-1===p.id._getIdenticalSvcIdx(d,
c)&&c.resources.splice(0,0,d)}return a}).always(function(a){delete b._credential;a&&(a.ssl=!!b._ssl)});var u=b.load,v=b.error;u&&a.then(function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return u.call(c&&c.args,b,c)});v&&a.then(null,function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return v.call(c&&c.args,b,c)})}if(p.id&&!t&&!b._token&&!p.id._isPublic(b.url)&&(!g||m))if(c=p.id.findCredential(b.url))b._token=c.token,b._ssl=c.ssl;d?b.workerOptions&&b.workerOptions.worker?(C=b.workerOptions.worker,e(a)):W(["./workers/RequestClient"],
function(c){if(b.workerOptions){var d=b.workerOptions;C=c.getClient(d.callback,d.cbFunction)}else C=c.getClient();e(a)}):e(a);return a.promise}function ea(a,c,b,f){a._pendingDfd=p.id.getCredential(c.url,{token:c._token,error:f});a._pendingDfd.then(function(e){c._token=e.token;c._credential=e;c._ssl=c._sslFromServer||e.ssl;w(a,!0,c,b)}).then(null,function(b){a.reject(b);a._pendingDfd=null})}function l(a,c){"string"!==typeof a&&console.error("esri/request: the first parameter should be a url string");
var b=n.mixin({},c),f={url:a,requestOptions:n.mixin({},c)};b.content=b.query;delete b.query;b.preventCache=!!b.cacheBust;delete b.cacheBust;b.handleAs=b.responseType;delete b.responseType;"array-buffer"===b.handleAs&&(b.handleAs="arraybuffer");if("image"===b.handleAs){if(q("host-webworker"))return r.reject(n.mixin(Error(),{message:"The responseType 'image' is not supported in Web Workers or Node environment."}));b.preventCache&&(b.content=b.content||{},b.content["request.preventCache"]=Date.now());
b.method="auto"}b.url=g.normalize(a);"file"!==g.appUrl.scheme&&(b.url=g.makeAbsolute(b.url));b.urlObj=new J(b.url);var e=Z.makeDeferredCancellingPending();X(V(b)).always(function(){w(e,!1,b,f)});return e.promise}var v,h=Y.request,da=["COM_0056","COM_0057"],ca=0;l._makeRequest=F;l._processRequest=w;l._disableCors=P;l._detectCors=V;l.setRequestPreCallback=function(a){v=a};return l});